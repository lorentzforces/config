#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# git commit browser, like git log + fuzzy-finding

ARGS=$*
main() {
	local CMD="git ls --color=always"
	if [[ -n "$ARGS" ]]; then
		CMD="git ls --color=always $ARGS"
	fi
	eval "$CMD" |
	fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
		--bind "ctrl-m:execute: \
			printf {} \
			| ( \
				grep -o '\<[a-f0-9]\+\>' \
				| head -1 \
				| xargs -I % sh -c 'git show --color=never % \
				| nvim -R -'
			)"
}
main
