#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

FILE_PATH="$HOME/upgradable-packages.txt"

if [ -f "$FILE_PATH" ]; then
	rm "$FILE_PATH"
fi

# check for apt-get because just "apt" can also be a java executable
if command -v apt-get &> /dev/null; then
	echo -e "Fetching apt packages..."
	sudo apt-get update &> /dev/null
	{
		echo -e "### Upgradable packages from apt: ###\n";
		apt list --upgradable;
		echo -e "\n\n";
	} >> "$FILE_PATH"
fi

if command -v dnf &> /dev/null; then
	echo -e "Fetching dnf packages..."
	# we could do this in one line, but this way we don't get the progress updates in the output
	dnf check-update --refresh &> /dev/null
	{
		echo -e "### Upgradable packages from dnf: ###\n";
		dnf list --updates;
		echo -e "\n\n";
	} >> "$FILE_PATH"
fi

if command -v zypper &> /dev/null; then
	echo -e "Checking zypper dist-upgrade items...";

	BASE_RESULTS=$(sudo zypper --non-interactive dist-upgrade --dry-run --details --auto-agree-with-licenses);

	IMPORTANT_PACKAGES=$( \
		echo "$BASE_RESULTS" | \
		rg "^openSUSE-release\s|^kernel\s|^nvidia-video-[[:alnum:]]+\s|^neovim\s" -A1 --no-context-separator \
	);
	PACKAGE_SUMMARY=$( \
		echo "$BASE_RESULTS" | \
		rg "packages to upgrade" --no-context-separator \
	);

	{
		echo -e "### Packages upgraded in most recent dist-upgrade snapshot: ###\n"
		echo -e "$PACKAGE_SUMMARY\n"
		echo -e "$IMPORTANT_PACKAGES\n"
	} >> "$FILE_PATH"
fi

if command -v brew &> /dev/null; then
	echo -e "Fetching homebrew packages..."

	# brew prints status information to stderr, which is noisy and annoying
	BASE_RESULTS=$(brew upgrade --dry-run 2> /dev/null)
	PACKAGE_LIST=$(echo "$BASE_RESULTS" | rg "\->" --no-context-separator)
	{
		echo -e "### Upgradable packages from homebrew: ###\n";
		echo -e "$PACKAGE_LIST\n"
	} >> "$FILE_PATH"
fi

if command -v flatpak &> /dev/null; then
	echo -e "Fetching flatpak packages..."
	{
		echo -e "### Upgradable packages from flatpak: ###\n";
		flatpak remote-ls --updates;
		echo -e "\n\n";
	} >> "$FILE_PATH"
fi
